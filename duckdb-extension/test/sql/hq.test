# name: test/sql/hq.test
# description: Test hq extension
# group: [hq]

# Before we load the extension, this will fail
statement error
SELECT html_query('<html><title>Test</title></html>', 'title');
----
Catalog Error: Scalar Function with name html_query does not exist!

# Require statement will ensure the extension is loaded from now on
require hq

# Test basic HTML parsing
query I
SELECT html_query('<html><head><title>Test Page</title></head></html>', 'title');
----
<title>Test Page</title>

# Test text extraction
query I
SELECT html_query('<html><body><p>Hello World</p></body></html>', 'p', true);
----
Hello World

# Test CSS selectors - class
query I
SELECT html_query('<html><body><div class="content">Content</div></body></html>', '.content', true);
----
Content

# Test CSS selectors - id
query I
SELECT html_query('<html><body><div id="main">Main</div></body></html>', '#main', true);
----
Main

# Test CSS selectors - attribute
query I
SELECT html_query('<html><body><a href="/test">Link</a></body></html>', 'a[href="/test"]', true);
----
Link

# Test CSS pseudo-selectors
query I
SELECT html_query('<div><p>First</p><p>Second</p><p>Third</p></div>', 'p:last-child', true);
----
Third

query I
SELECT html_query('<div><p>First</p><p>Second</p><p>Third</p></div>', 'p:first-child', true);
----
First

query I
SELECT html_query('<div><p>First</p><p>Second</p><p>Third</p></div>', 'p:nth-child(2)', true);
----
Second

# Test with NULL input
query I
SELECT html_query(NULL, 'title');
----
NULL

# Test with default selector using single parameter
query I
SELECT html_query('<html><head><title>Test</title></head></html>') LIKE '%<title>Test</title>%';
----
true

# Test from table
statement ok
CREATE TABLE pages AS SELECT '<html><head><title>Page 1</title></head></html>' as html
UNION ALL SELECT '<html><head><title>Page 2</title></head></html>' as html;

query I
SELECT html_query(html, 'title', true) FROM pages ORDER BY 1;
----
Page 1
Page 2

# Test nested selectors
query I
SELECT html_query('<html><body><div><span>Nested</span></div></body></html>', 'div > span', true);
----
Nested

# Test html_extract_json with LD+JSON
query I
SELECT html_extract_json('<html><head><script type="application/ld+json">{"@type":"Product","name":"Widget"}</script></head></html>', 'script[type="application/ld+json"]') LIKE '%Widget%';
----
true

# Test html_extract_json parses and returns valid JSON
query II
SELECT
  json_extract_string(html_extract_json('<html><head><script type="application/ld+json">{"name":"Widget A","price":"19.99"}</script></head></html>', 'script[type="application/ld+json"]'), '$.name') as name,
  json_extract_string(html_extract_json('<html><head><script type="application/ld+json">{"name":"Widget A","price":"19.99"}</script></head></html>', 'script[type="application/ld+json"]'), '$.price') as price;
----
Widget A	19.99

# Test html_extract_json with JS variable
query I
SELECT html_extract_json('<html><script>var config = {"debug": true};</script></html>', 'script', 'var config');
----
{"debug":true}

# Test html_extract_json decodes HTML entities in LD+JSON
query I
SELECT json_extract_string(html_extract_json('<html><script type="application/ld+json">{"title":"Test &amp; Demo"}</script></html>', 'script[type="application/ld+json"]'), '$.title');
----
Test & Demo

# Test html_extract_json with NULL
query I
SELECT html_extract_json(NULL, 'script');
----
NULL

# Cleanup
statement ok
DROP TABLE pages;
