# name: test/sql/html_query.test
# description: Test html_query extension
# group: [html_query]

# Before we load the extension, this will fail
statement error
SELECT html_query('<html><title>Test</title></html>', 'title');
----
Catalog Error: Scalar Function with name html_query does not exist!

# Require statement will ensure the extension is loaded from now on
require html_query

# Test basic HTML parsing
query I
SELECT html_query('<html><head><title>Test Page</title></head></html>', 'title');
----
<title>Test Page</title>

# Test text extraction
query I
SELECT html_query('<html><body><p>Hello World</p></body></html>', 'p', '@text');
----
Hello World

# Test CSS selectors - class
query I
SELECT html_query('<html><body><div class="content">Content</div></body></html>', '.content', '@text');
----
Content

# Test CSS selectors - id
query I
SELECT html_query('<html><body><div id="main">Main</div></body></html>', '#main', '@text');
----
Main

# Test CSS selectors - attribute
query I
SELECT html_query('<html><body><a href="/test">Link</a></body></html>', 'a[href="/test"]', '@text');
----
Link

# Test CSS pseudo-selectors
query I
SELECT html_query('<div><p>First</p><p>Second</p><p>Third</p></div>', 'p:last-child', '@text');
----
Third

query I
SELECT html_query('<div><p>First</p><p>Second</p><p>Third</p></div>', 'p:first-child', '@text');
----
First

query I
SELECT html_query('<div><p>First</p><p>Second</p><p>Third</p></div>', 'p:nth-child(2)', '@text');
----
Second

# Test with NULL input
query I
SELECT html_query(NULL, 'title');
----
NULL

# Test with default selector using single parameter
query I
SELECT html_query('<html><head><title>Test</title></head></html>') LIKE '%<title>Test</title>%';
----
true

# Test from table
statement ok
CREATE TABLE pages AS SELECT '<html><head><title>Page 1</title></head></html>' as html
UNION ALL SELECT '<html><head><title>Page 2</title></head></html>' as html;

query I
SELECT html_query(html, 'title', '@text') FROM pages ORDER BY 1;
----
Page 1
Page 2

# Test nested selectors
query I
SELECT html_query('<html><body><div><span>Nested</span></div></body></html>', 'div > span', '@text');
----
Nested

# Test html_query_all returns VARCHAR[]
query I
SELECT html_query_all('<div><p>First</p><p>Second</p></div>', 'p', '@text');
----
[First, Second]

# Test html_query_all with list functions
query I
SELECT list_extract(html_query_all('<div><p>A</p><p>B</p><p>C</p></div>', 'p', '@text'), 2);
----
B

# Test html_query_all empty result
query I
SELECT html_query_all('<div><p>Only</p></div>', 'span', '@text');
----
[]

# Test attribute extraction - href
query I
SELECT html_query('<a href="/page">Link</a>', 'a', '@href');
----
/page

# Test attribute extraction - data attribute
query I
SELECT html_query('<div data-test-id="submit-btn">Submit</div>', 'div', 'data-test-id');
----
submit-btn

# Test html_query_all with href extraction
query I
SELECT html_query_all('<nav><a href="/home">Home</a><a href="/about">About</a></nav>', 'a', '@href');
----
[/home, /about]

# Test html_extract_json with LD+JSON
query I
SELECT html_extract_json('<html><head><script type="application/ld+json">{"@type":"Product","name":"Widget"}</script></head></html>', 'script[type="application/ld+json"]') LIKE '%Widget%';
----
true

# Test html_extract_json parses and returns valid JSON (returns array)
query II
SELECT
  json_extract_string(html_extract_json('<html><head><script type="application/ld+json">{"name":"Widget A","price":"19.99"}</script></head></html>', 'script[type="application/ld+json"]'), '$[0].name') as name,
  json_extract_string(html_extract_json('<html><head><script type="application/ld+json">{"name":"Widget A","price":"19.99"}</script></head></html>', 'script[type="application/ld+json"]'), '$[0].price') as price;
----
Widget A	19.99

# Test html_extract_json with JS variable (returns array)
query I
SELECT html_extract_json('<html><script>var config = {"debug": true};</script></html>', 'script', 'var config');
----
[{"debug":true}]

# Test html_extract_json decodes HTML entities in LD+JSON
query I
SELECT json_extract_string(html_extract_json('<html><script type="application/ld+json">{"title":"Test &amp; Demo"}</script></html>', 'script[type="application/ld+json"]'), '$[0].title');
----
Test & Demo

# Test html_extract_json with NULL
query I
SELECT html_extract_json(NULL, 'script');
----
NULL

# Cleanup
statement ok
DROP TABLE pages;
